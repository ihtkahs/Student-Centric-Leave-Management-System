<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apply Leave</title>
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <script src="{% static 'js/base.js' %}" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <style>
        #chatbox-container {
            display: none;
            width: 50%;
            margin: 20px auto;
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 8px;
            background: #f9f9f9;
        }
        #chatbox {
            height: 300px;
            overflow-y: auto;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
        }
        .user, .bot {
            padding: 8px;
            margin: 5px;
            border-radius: 5px;
        }
        .user { background: lightblue; text-align: right; }
        .bot { background: lightgray; text-align: left; }
    </style>
</head>
<body>
    <div id="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar">
            <ul>
                <li><a href="{% url 'student_dashboard' %}">Dashboard</a></li>
                <li><a href="{% url 'apply_leave' %}">Apply Leave</a></li>
                <li><a href="{% url 'leave_history' %}">Leave History</a></li>
                <li><a href="{% url 'my_profile' %}">My Profile</a></li>
                <li><a href="{% url 'logout' %}">Logout</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div id="content">
            <header>
                <button id="sidebarToggle">&#9776;</button>
                <h1>Apply Leave</h1>
            </header>
        </div>
    </div>

    <main>
        <h2>Choose how you want to apply for leave:</h2>
        <button onclick="toggleChatbot()">Use Chatbot for Leave Request</button>

        <!-- Chatbot Section -->
        <div id="chatbox-container">
            <h3>Leave Request Chatbot</h3>
            <div id="chatbox"></div>
            <input type="text" id="userInput" placeholder="Type your message..." />
            <button onclick="sendMessage()">Send</button>
        </div>

        <hr>

        <h3>Manual Leave Application</h3>
        {% if success_message %}
            <div id="successMessage" style="display: none;">{{ success_message }}</div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="leaveForm">
            {% csrf_token %}

            <div>{{ form.leave_type.label }}</div>
            <div>{{ form.leave_type }}</div>
            {% if form.leave_type.errors %}
                <div class="text-danger">
                    {% for error in form.leave_type.errors %}
                        <small>{{ error }}</small><br>
                    {% endfor %}
                </div>
            {% endif %}

            <div>{{ form.duration.label }}</div>
            <div>{{ form.duration }}</div>
            {% if form.duration.errors %}
                <div class="text-danger">
                    {% for error in form.duration.errors %}
                        <small>{{ error }}</small><br>
                    {% endfor %}
                </div>
            {% endif %}

            <div>{{ form.reason.label }}</div>
            <div>{{ form.reason }}</div>
            {% if form.reason.errors %}
                <div class="text-danger">
                    {% for error in form.reason.errors %}
                        <small>{{ error }}</small><br>
                    {% endfor %}
                </div>
            {% endif %}

            <div id="dateField" style="display: none;">
                <p>{{ form.date.label }}</p>
                <div>{{ form.date }}</div>
                {% if form.date.errors %}
                    <div class="text-danger">
                        {% for error in form.date.errors %}
                            <small>{{ error }}</small><br>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div id="dateRangeField" style="display: none;">
                <p>{{ form.start_date.label }}</p>
                <div>{{ form.start_date }}</div>
                {% if form.start_date.errors %}
                    <div class="text-danger">
                        {% for error in form.start_date.errors %}
                            <small>{{ error }}</small><br>
                        {% endfor %}
                    </div>
                {% endif %}

                <p>{{ form.end_date.label }}</p>
                <div>{{ form.end_date }}</div>
                {% if form.end_date.errors %}
                    <div class="text-danger">
                        {% for error in form.end_date.errors %}
                            <small>{{ error }}</small><br>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div id="proofField" style="display: none;">
                <p>{{ form.proof.label }}</p>
                <div>{{ form.proof }}</div>
                {% if form.proof.errors %}
                    <div class="text-danger">
                        {% for error in form.proof.errors %}
                            <small>{{ error }}</small><br>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>

            <button type="submit">Submit</button>
        </form>
    </main>

    <script>
        function toggleChatbot() {
            var chatbot = document.getElementById("chatbox-container");
            chatbot.style.display = chatbot.style.display === "none" ? "block" : "none";
        }

        function sendMessage() {
            let userText = document.getElementById("userInput").value;
            if (userText.trim() === "") return;

            document.getElementById("chatbox").innerHTML += `<div class='user'>${userText}</div>`;
            document.getElementById("userInput").value = "";

            fetch("{% url 'chatbot_response' %}", {
                method: "POST",
                headers: { 
                    "X-CSRFToken": "{{ csrf_token }}", 
                    "Content-Type": "application/x-www-form-urlencoded" 
                },
                body: "message=" + encodeURIComponent(userText)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById("chatbox").innerHTML += `<div class='bot'>${data.response}</div>`;
            });
        }
    </script>
</body>
</html>

